---
title: "R Notebook"
output: html_notebook
---


```{r,fig.width=12,fig.height=6}
jerby.plot <- DimPlot(object = tcell.gating$Jerby, reduction = "umap", group.by = "scGate.annotation", label = TRUE, label.size = 3, repel = TRUE) + ggtitle("Jerby et. al.") + labs(subtitle = "sc.Gate.annotation") +  theme(legend.text = element_text(size=7)) +  theme(plot.subtitle = element_text(hjust = 0.5)) +theme(legend.position="bottom")


yost.plot <- DimPlot(object = tcell.gating$Yost, reduction = "umap", group.by = "scGate.annotation", label = TRUE, label.size = 3, repel = TRUE) + ggtitle("Yost et. al.") + labs(subtitle = "sc.Gate.annotation") +  theme(legend.text = element_text(size=7)) +  theme(plot.subtitle = element_text(hjust = 0.5)) +theme(legend.position="bottom")

jerby.plot + yost.plot
```

Notice that the applied T cell model contains only one layer. This means that in one step we are filtering T cells from other cell types, excluding at the same time contaminants like doublets, triplets etc. 
When a user is interested in more specific cell types, namely gating TCD8 cells, it is strongly recommended to do the job in an iterative manner. Keeping this into account, scGate enables users to build (and use) multi-layer models, like the TCD8 model pre-computed model available in scGate_DB. In their first layer this model gates all pure T cells, and in the second layer the model applies specific TCD8 signatures to pick out these cells in a fine-grained way.


## Gating TCD8 cells: two layered model. 

A scGate multi-layer model is simply an R list of scGate models (warning: order matters). Models will be executed in an itterative manner
```{r}
## explore the pre-built two-layer model. 
TCD8.model <- scGate_DB$human$CD8.Tcell
TCD8.model%>%class()
TCD8.model%>%names()
class(TCD8.model[["Tcell_CD8"]])
```

We only need to apply the two layer pre-trained model of TCD8 cells available in scGate_DB 
* This may take a few minutes, you can drink a cup of coffee in the meantime.
```{r, message=F}
if(!file.exists('./input/tcd8.human.sets.rds')){
  tcd8.gating <- lapply(dataset.list,function(data){
    gated.object <- scGate(data = data, gating.model = scGate_DB$human$CD8.Tcell,
                           sd.in = 4,      
                           sd.out = 7,  # reducing this threshold the gating will be more conservative 
                           return_signature_scores = T)  
    return(gated.object)
  })
  saveRDS(tcd8.gating,'./input/tcd8.human.sets.rds')

}else{
  tcd8.gating <- readRDS('./input/tcd8.human.sets.rds')
}

```

```{r,fig.width=12,fig.height=6}
jerby.plot <- DimPlot(object = tcd8.gating$Jerby, reduction = "umap", group.by = "is.pure", label = TRUE, label.size = 3, repel = TRUE) + ggtitle("Jerby et. al.") + labs(subtitle = "TCD8") +  theme(plot.subtitle = element_text(hjust = 0.5)) 


yost.plot <- DimPlot(object = tcd8.gating$Yost, reduction = "umap", group.by = "is.pure", label = TRUE, label.size = 3, repel = TRUE) + ggtitle("Yost et. al.") + labs(subtitle = "TCD8") +  theme(plot.subtitle = element_text(hjust = 0.5))

jerby.plot + yost.plot
```

Comparing results among authors' defined cell types
```{r, results='asis'}
writeLines("td, th { padding : 6px } th { background-color : brown ; color : white; border : 1px solid white; } td { color : brown ; border : 1px solid brown }", con = "mystyle.css")

# Jerby
knitr::kable(table(tcd8.gating$Jerby@meta.data[,c("cell_type","is.pure")]),format = "html")

# Yost
knitr::kable(table(tcd8.gating$Yost@meta.data[,c("cell_type","is.pure")]),format = "html")

```


## Further reading
The code and the package are available at the *scGate* [GitHub repository](https://github.com/carmonalab/scGate)

 Arreglar esto

* We will gate these datasets taking advantage of the *Tcell* pre-computed model with default parameters.  
* We are explicitly seting *sd.in* and *sd.out* parammeters with their default values only for teaching purposes. 
* Notice that reducing sd.in or sd.out thresholds translates in a more conservative gating process.
* By setting *return_signature_scores* = T we incorporate signature scores into the meta.data object. 

```{r,results=F}
#renv::snapshot()
```



## De novo analysis (namely: Bubin, Bassez)
## Validation 1 layer Done!  Add advanced analysis : zscore ubicacion y ploteo de algunos
## Validation 2 layers (Jerby Arnon Cd8). Advance feature, quizÃ¡s como mover thresholds
 

