---
title: "Isolating cell subsets with scGate: a de novo analysis"
author: "M. Andreatta, A. Berenstein and S. Carmona"
date: "31/08/2021"
output:
  rmdformats::readthedown:
    self-contained: true
    highlight: haddock
    thumbnails: false
    css: styles.css
knit: (function(input_file, encoding) {
  out_dir <- 'docs';
  rmarkdown::render(input_file, encoding=encoding,
 output_file=file.path(dirname(input_file), out_dir, 'de_novo_analysis.vignette.html'))})
---

# Preliminars
## Background
**scGate** is an open source tool designed for gating specific and uncontaminated cell types in a scRNAseq experiment. We aim to gate cell subtypes at high precision/PPV (i.e achieving high cell type purity) and we donâ€™t care about some loss of true cells (i.e. sensitivity > 90% is ideal). We aim at a reliable tool to purify individual cell types from scRNA-seq data from complex samples (e.g. whole tissue, whole tumor) to enable i) downstream cell type-specific analysis (e.g. reference-atlas projection) and ii) cross-study comparisons/meta-analysis of cell types.

# This demo
In previous vignettes ([tcell.html](url_tcell.html) and [tced8.html](url_tced8.html)), we show basic functionality and usage of scGate package over well annotated datasets. In this demo, we present a more realistic situation, namely, when cell types are not known a priori and you are interested in usage scGate for de-novo isolation of any cellular subset of interest. We will work with a mouse dataset [Gubin 2018](https://pubmed.ncbi.nlm.nih.gov/30388455/),  [Yost.2019](https://www.nature.com/articles/s41591-019-0522-3)   


# R Environment

Using Renv
```{r, message=F, warning=F,results=F}
if (!requireNamespace("renv")) install.packages("renv")
renv::activate()
renv::restore()
library(gridExtra)
library(ggplot2)
library(reshape2)
library(GEOquery)
library(patchwork)
library(Seurat)
library(cowplot)
```

Or alternatively, manually installing scGate from GitHub
```{r, eval=F, message=F, warning=F}
if (!requireNamespace("remotes")) install.packages("remotes")
remotes::install_github("carmonalab/UCell")
remotes::install_github("carmonalab/scGate")
library(scGate)

if (!requireNamespace("GEOquery")){ 
  install.packages("BiocManager")
  BiocManager::install("GEOquery")
}

```


```{r setup, echo=FALSE, message=F, warning=F, results=F}
library(knitr)
library(rmdformats)
library(formatR)


## Global options
options(max.print="75")
opts_chunk$set(echo=TRUE,
	             cache=TRUE,
               cache.lazy=FALSE,
               prompt=FALSE,
               tidy=TRUE,
               comment=NA,
               message=FALSE,
               warning=FALSE,
               dev='png')
opts_knit$set(width=75)

## figure output path 
figure.path <- "~/Dropbox/CSI/PAPERS/scGate/Figures"
```



```{r,echo =F,results=F,message=F}
Gubin.raw.data <- 'aux/Gubin_CD45_raw.rds'
if(file.exists(Gubin.raw.data)) data.seurat.raw <- readRDS(Gubin.raw.data)  

#Gubin.clean.data <- 'aux/Gubin_CD45_clean.rds'
#if(file.exists(Gubin.clean.data)) data.seurat <- readRDS(Gubin.clean.data)  
```

# Download and process Gubin mouse dataset 
Brief description

```{r,eval =F}
geo_acc <- "GSE119352"
do_download <- T

gse <- getGEO(geo_acc)
datadir <- "input/Gubin"
dir.create(datadir)

series <- paste0(geo_acc, "_series_matrix.txt.gz")
if(do_download){
  getGEOSuppFiles(geo_acc,baseDir=datadir)
  system(paste0("gunzip ",datadir,"/",geo_acc,"/*meta_data.tsv.gz")) 
  
  for (acc in gse[[series]]$geo_accession) {
    dir.create(file.path(datadir, acc))
    getGEOSuppFiles(acc,baseDir=datadir) #untar...
    fns <- list.files(paste0(datadir,"/",acc,"/"))
    for (fn in fns){  #rename to basic names: matrix, genes, barcodes
      system(paste0("mv ",paste0(datadir,"/",acc,"/",fn)," ",paste0(datadir,"/",acc,"/",sub(".*_","",fn,perl = T))))
    }
    system(paste0("gunzip ",datadir,"/",acc,"/*gz"))
    
  }
}

#as.character(gse[[1]]$title[gse[[1]]$geo_accession==acc])
geoAccToName <- gse[[1]]$title
names(geoAccToName) <-  gse[[1]]$geo_accession

```

Read the sparse count matrices 
```{r readMatrix, eval=F}
data.list <- list()

for (i in 1:length(gse[[series]]$geo_accession)) {
   acc = gse[[series]]$geo_accession[i]
   fname <- paste0(datadir,"/",acc)
   data <- Read10X(fname)
   title <- gse[[1]]$title[i]
   
   c <- gsub(pattern="(\\S+)", replacement=paste0("GU-\\1-",i), colnames(data), perl=TRUE)
   colnames(data) <- c
   
   tmp.seurat <- CreateSeuratObject(counts = data, project = "Gubin", min.cells = 3, min.features = 50)
   tmp.seurat@meta.data$Sample <- acc
   tmp.seurat@meta.data$Condition <- title
   
   data.list[[title]] <- tmp.seurat
   rm(tmp.seurat)
}

names(data.list)

data.list[[1]]$Treatment <- "Control" 
data.list[[2]]$Treatment <- "aPD1"
data.list[[3]]$Treatment <- "aCTLA4"
data.list[[4]]$Treatment <- "aPD1_aCTLA4"

data.seurat.raw <- Reduce(merge, data.list)
```

# Data Preprocessing
```{r, eval=T, collapse=T}
# basic information of generated seurat object
data.seurat.raw

# Condition composition
table(data.seurat.raw$Condition)

# Sample composition
table(data.seurat.raw$Sample)

# Treatment composition
table(data.seurat.raw$Treatment)

```


## Ribosomal and mitochondrial content
```{r,eval =F}
percent.ribo.dv <- PercentageFeatureSet(data.seurat.raw, pattern = "^Rp[ls]")
percent.mito.dv <- PercentageFeatureSet(data.seurat.raw, pattern = "^mt-")

data.seurat.raw <- AddMetaData(data.seurat.raw, metadata = percent.ribo.dv, col.name = "percent.ribo")
data.seurat.raw <- AddMetaData(data.seurat.raw, metadata = percent.mito.dv, col.name = "percent.mito")
```

Look at distributions per sample
```{r fig.height=3,fig.width= 10}
pl <- VlnPlot(data.seurat.raw, features = c("nFeature_RNA", "nCount_RNA","percent.ribo","percent.mito"), ncol = 4, pt.size=0, combine=FALSE, 
              group.by ='Treatment')

pll <- list()
for (i in seq_along(pl)) {
   pll[[i]] = pl[[i]] + theme(axis.text.x = element_blank(), legend.position = "none")
}

plot_grid(plotlist = pll, ncol = 4)
```

```{r, collapse = T}
## nFeatures
summary(data.seurat.raw@meta.data$nFeature_RNA)

## nCounts
summary(data.seurat.raw@meta.data$nCount_RNA)

# % ribo
summary(data.seurat.raw@meta.data$percent.ribo)

# % mito
summary(data.seurat.raw@meta.data$percent.mito)
```

## Basic quality control
```{r, collapse= T}
# before filtering
sprintf("%s cells before filtering",dim(data.seurat.raw)[2])

data.seurat <- subset(data.seurat.raw, subset = nFeature_RNA>500 & nFeature_RNA<4000 & 
                       nCount_RNA>1000 & nCount_RNA<15000 &
                       percent.ribo < 50 & percent.mito < 10)

# after filtering
sprintf("%s cells after filtering",dim(data.seurat)[2])
```

```{r,eval =F,echo =F,results =F}
dir.create("aux")
saveRDS(data.seurat.raw, file="aux/Gubin_CD45_raw.rds")
```

## Data normalization and unsupervised analysis

```{r, eval =T, echo = F}
Gubin.clean.data <- 'aux/Gubin_CD45_clean.rds'
if(file.exists(Gubin.clean.data)) data.seurat <- readRDS(Gubin.clean.data)  
```

```{r, message=F, results=F, eval =F}
ndim=30
set.seed(1234)

data.seurat <- NormalizeData(data.seurat, verbose = FALSE)
data.seurat <- FindVariableFeatures(data.seurat, selection.method = "vst", nfeatures = 1000, verbose = FALSE)
bk.list <- unlist(scGate::genes.blacklist.Mm)     

data.seurat@assays$RNA@var.features <- setdiff(data.seurat@assays$RNA@var.features, bk.list)

data.seurat <- ScaleData(data.seurat)
data.seurat <- RunPCA(data.seurat, features = data.seurat@assays$RNA@var.features, ndims.print = 1:5, nfeatures.print = 5, npcs = ndim)

## Run Umap
data.seurat <- RunUMAP(data.seurat, reduction = "pca", dims = 1:ndim, seed.use=123)

```

## 2D visualization using UMAP
```{r,message=F, results=F}
DimPlot(data.seurat, reduction = "umap", group.by = "Treatment") + ggtitle("UMAP by sample")
```

Plot some clasical markers
```{r, fig.height=15, fig.width=12}
features=c("Ptprc","Lck","Csf1r","Cd3e","Foxp3","Cd8a","Cd4","H2-Eb1","H2-Aa","Cd300e",
           "Itgal","C1qa","C1qb","Gpnmb","Fabp5","Saa3",
           "Clec10a","Irf8","Ccr7","S100a9","Plac8","Xcr1","Spi1",
           "Siglech","Ccr9","nCount_RNA","nFeature_RNA")

plt.classical.mkr <- FeaturePlot(data.seurat, reduction="umap", features=features, order = T,ncol = 4)

plot(plt.classical.mkr)
```
Display some selected markers
```{r fig.height=7, fig.width=8}
features=c("Lck","Csf1r","Spi1","Cd3e","H2-Eb1","Ccr7","S100a9","Xcr1","Siglech")

plt.selected.mkr <- FeaturePlot(data.seurat, reduction="umap", features=features, order = T,ncol = 3, max.cutoff = 'q99')
plot(plt.selected.mkr)
```
```{r,echo =F}
ggsave(file.path(figure.path,"Gubin_select_markers_UMAP.png"), plot=plt.selected.mkr, width=14, height=10)
```


Export full dataset 
```{r, eval = F}
dir.create("aux")
saveRDS(data.seurat, file="aux/Gubin_CD45_clean.rds")
```


# scGate for isolating cell subsets

## Filter on T cells

```{r}
ffile = "./aux/tcell.gubin.rds"
if(file.exists(ffile)){
  gate = F
  data.myel.scgate <- readRDS(ffile)
}else{
  gate = T
}
```

```{r, eval = gate}
data.T <- scGate(data.seurat, gating.model = scGate_DB$mouse$Tcell, sd.out = 5)
saveRDS(data.T,ffile)
```

```{r, fig.width= 9,fig.height=8,eval =F}
plt.ispure <- DimPlot(data.T, group.by =  'is.pure')
plt.ann <- DimPlot(data.T , group.by="scGate.annotation")

features=c("Lck","Cd3e","Fcer1g")
lymphoid <- FeaturePlot(data.seurat, reduction="umap",ncol =3,features=features, order = T, max.cutoff = 'q99')

layout <- "
AAAAA
BB#CC"
wrap_plots(A = lymphoid , B = plt.ispure , C =  plt.ann, design = layout)
```

## Filter myeloid APCs 

scGate APC model
```{r}
ffile = "./aux/apc.gubin.rds"
if(file.exists(ffile)){
  gate = F
  data.myel.scgate <- readRDS(ffile)
}else{
  gate = T
}
```

```{r, eval = gate}
data.myel.scgate <- scGate(data.seurat, gating.model = scGate_DB$mouse$Monocyte_Macrophage_Dendritic_pDendritic, sd.in=3, sd.out = 7)
saveRDS(data.myel.scgate,ffile)
```



```{r,fig.height=10,fig.width=6}
plt.ispure <- DimPlot(data.myel.scgate, group.by =  'is.pure')
plt.ann <- DimPlot(data.myel.scgate , group.by="scGate.annotation")

features=c("Csf1r","Spi1","H2-Eb1", "S100a9")
apcs <- FeaturePlot(data.seurat, reduction="umap",ncol =2,features=features, order = T, max.cutoff = 'q99')

layout <- "
AA
AA
BB
CC"
wrap_plots(A = apcs , B = plt.ispure , C =  plt.ann, design = layout)

```


Project into myeloid atlas
Load atlas
```{r, eval =F, echo = F}
ref <- load.reference.map("APC_atlas_v1.2.rds")

DimPlot(ref, label = T, group.by = "functional.cluster", cols = ref@misc$atlas.palette, repel = T, label.size = 4) + theme(aspect.ratio=0.8)
```



#Project Gubin data into reference myeloid atlas
```{r, eval =F, echo =F}
data.split <- SplitObject(data.myel, split.by = "Treatment")

query.projected <- make.projection(query=data.split, ref=ref, filter.cells = F, ncores = 4)
```



```{r fig.height=5, fig.width=8, eval =F, echo =F}
library(patchwork)

pll <- list()
for (sample in names(query.projected)) {
  
    query.projected[[sample]] <- cellstate.predict(ref=ref, query=query.projected[[sample]])

    pll[[sample]] <- plot.projection(ref=ref, query=query.projected[[sample]], linesize = 0.3) + ggtitle(sample)
}
g <- wrap_plots(pll)
g

ggsave("out/Gubin_APC_projection.png", plot=g, width=12, height=8)

```


```{r fig.height=6, fig.width=6, eval =F, echo =F}
p <- plot.states.radar(ref=ref, query=query.projected, genes4radar = c(ref@misc$gene.panel,"Cx3cr1","Nos2"), return=T, min.cells = 100)
plot(p)
```

```{r, eval =F, echo =F}
#Combined, stacked barplot
states_all <- levels(as.factor(ref$functional.cluster))
stateColors_func <- ref@misc$atlas.palette

m <- matrix(nrow = length(names(query.projected)), ncol = length(states_all))
rownames(m) <- names(query.projected)
colnames(m) <- states_all
m.int <- m
for (i in seq_along(query.projected)) {
  tb <- table(factor(query.projected[[i]]$functional.cluster, levels = states_all))
  m[i, ] <- tb * 100/sum(tb)
  m.int[i, ] <- tb
}

melt <- melt(m)
melt.int <- melt(m.int)
melt <- cbind(melt, melt.int$value)
colnames(melt) <- c("Sample", "Cell_state", "Percent","Ncells")

g <- ggplot(melt, aes(x = Sample, y = Percent, fill = Cell_state, Ncells = Ncells)) + geom_bar(stat = "identity", 
    position = "stack") + scale_fill_manual(values = stateColors_func) + 
    theme_light() + theme(legend.position = "right") + ylab("Percentage of cells")
g

ggsave("Gubin.APC.composition.combined.png", plot=g, height=4.5, width=6)

```
