---
title: "Intuitive Immune Isolation of cell types with scGate. Basic examples"
author: "M. Andreatta, A. Berenstein and S. Carmona"
date: "29/09/2021"
output:
  rmdformats::readthedown:
    self-contained: true
    highlight: haddock
    thumbnails: false
    css: styles.css
knit: (function(input_file, encoding) {
  out_dir <- 'docs';
  rmarkdown::render(input_file, encoding=encoding,
 output_file=file.path(dirname(input_file), out_dir, 'scGate.basic.usage.html'))})
---


```{r, message=F, warning=F,results=F}
renv::restore()
library(ggplot2)
library(dplyr)
#remotes::install_github("carmonalab/scGate", ref='dev', force =T)
library(scGate)
#renv::snapshot()
```


```{r setup, echo=FALSE, message=F, warning=F, results=F}
library(knitr)
library(rmdformats)
library(formatR)


## Global options
options(max.print="75")
opts_chunk$set(echo=TRUE,
	             cache=TRUE,
               cache.lazy=FALSE,
               prompt=FALSE,
               tidy=TRUE,
               comment=NA,
               message=FALSE,
               warning=FALSE,
               dev='png')
opts_knit$set(width=75)

```

## Load some testing datasets and models

Load default models from DB
```{r}
models.DB <- scGate::get_scGateDB()

names(models.DB$human$generic)
names(models.DB$mouse$generic)
```

or alternatively, you can load models from your own personalized folder
```{r}
# models_path = '/home/user/custom_model'
# models <- scGate::load_models(models_path) 
```

### Have a look at some model (for B cells and plasma cells)
```{r message=F,results=F}
model <- models.DB$human$generic$PanBcell
plt.tree <- scGate::plot_tree(model)
plt.tree
```



## Run an example
#NOTE: I think these have too few cells, can we make them 1000 or 2000?
```{r}
testing.datasets <- readRDS(url("https://www.dropbox.com/s/8nugqcsjg2n26ba/testing.datasets.rds?dl=1"))
```

```{r,collapse =T}
# List available testing datasets:
names(testing.datasets)
# Select one
dset <- "Zilionis"
obj <- testing.datasets[[dset]]


```


```{r, collapse=T}
# run scGate
obj <- scGate(obj, model = models.DB$human$generic$PanBcell, assay = DefaultAssay(obj))
DimPlot(obj)
```
#TMP
```{r}
more <- list()
more$cycling <- c("TOP2A","STMN1","MKI67")
obj <- scGate(obj, model = models.DB$human$generic$PanBcell, assay = DefaultAssay(obj), additional.signatures = more)
DimPlot(obj)

```

## Visualize filtering results by layer

```{r,fig.height=8,fig.width=6 }
myCols <- grep("is.pure.", colnames(obj@meta.data),value = T)
plots <- list()
plots[["annotation"]] <- DimPlot(obj, group.by = "cell_type",label = T, repel =T) + ggtitle("Author's manual annot") + NoLegend()
for (myCol in myCols){
    plots[[myCol]] <- DimPlot(obj, group.by = myCol)
}
wrap_plots(plots, ncol = 2)
```

## Evaluate performance of filtering compared to original annotation
```{r,collapse=T}
perf.scGate = scGate::performance.metrics(actual = obj$PanBcell, pred = obj$is.pure== "Pure")
perf.scGate
```
