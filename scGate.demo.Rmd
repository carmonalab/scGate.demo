---
title: "Intuitive Immune Isolation of cell types with scGate. Basic examples"
author: "M. Andreatta, A. Berenstein and S. Carmona"
date: "29/09/2021"
output:
  rmdformats::readthedown:
    self-contained: true
    highlight: haddock
    thumbnails: false
    css: styles.css
knit: (function(input_file, encoding) {
  out_dir <- 'docs';
  rmarkdown::render(input_file, encoding=encoding,
 output_file=file.path(dirname(input_file), out_dir, 'scGate.basic.usage.html'))})
---


```{r, message=F, warning=F,results=F}
renv::restore()
library(ggplot2)
library(dplyr)
library(patchwork)
remotes::install_github("carmonalab/scGate",ref = "dev")
library(scGate)
```


```{r setup, echo=FALSE, message=F, warning=F, results=F}
library(knitr)
library(rmdformats)
library(formatR)


## Global options
options(max.print="75")
opts_chunk$set(echo=TRUE,
	             cache=TRUE,
               cache.lazy=FALSE,
               prompt=FALSE,
               tidy=TRUE,
               comment=NA,
               message=FALSE,
               warning=FALSE,
               dev='png')
opts_knit$set(width=75)

```




## Load some testing datasets 
```{r}
testing.datasets <- scGate:::get_testing_data(version = 'hsa.latest')
```

```{r,collapse =T, fig.width=7}
# List available testing datasets:
names(testing.datasets)
# Select one
#dset <- "Zilionis"
dset <- "Satija"
obj <- testing.datasets[[dset]]
DimPlot(obj, label = T, repel = T, group.by = "cell_type")
#FeaturePlot(obj,features = c("FOXP3","CD8B"))
```
Set up a simple gating model to test scGate and purify, for instance, platelts (then pDC, lymphoid, myeloid, B cells, Tregs)

## Simple gating model definition
```{r}
# model initizlization
my_scGate_model <- edit_model()  

# add a first signature
my_scGate_model <- edit_model(model = my_scGate_model, name = "Bcell", signature = c("MS4A1"))

```


## Purify cell population of interest with scGate
```{r, collapse=T}
# run scGate
obj <- scGate(data = obj, model = my_scGate_model, assay = DefaultAssay(obj))
DimPlot(obj, cols = c(list(Impure = "gray", Pure = "#00ae60")))
```

# Another example for gating Tcells
```{r}
# simple model building 
my_scGate_model <- edit_model()  # model initizlization
my_scGate_model <- edit_model(model = my_scGate_model, name = "Tcell", signature = c("CD3D","CD3G"),)  # add one positive signature

# run the model
obj <- scGate(data = obj, model = my_scGate_model, assay = DefaultAssay(obj))
DimPlot(obj, cols = c(list(Impure = "gray", Pure = "#00ae60")))
```
That simple model works fine detecting TCells but also display some contamination with platelets. We can add a negative signature at the same level model in order to improve precision. 

```{r}
#add one negative signature setting negative = T
my_scGate_model <- edit_model(model = my_scGate_model, name = "platelet", signature = c("PPBP"), negative=T)

# run the model
obj <- scGate(data = obj, model = my_scGate_model, assay = DefaultAssay(obj))
DimPlot(obj, cols = c(list(Impure = "gray", Pure = "#00ae60")))
```

## Take advantage of hierarchical structure of scGate models: 
Some celltypes like XXX could be dificult to isolate in a precise way at once filter step
```{r, collapse=T}
#model.only1layer <- edit_model()  # model initizlization
#model.only1layer <- edit_model(model = model.only1layer, name = "XX", signature = c(""))

#obj <- scGate(data = obj, model = model.only1layer, assay = DefaultAssay(obj))
#DimPlot(obj, cols = c(list(Impure = "gray", Pure = "#00ae60")))

```


```{r, collapse=T}
#hierachical.model <- edit_model()  # model initizlization
# Layer 1: retrive myeloid cells
#hierachical.model <- edit_model(model = hierachical.model, name = "Limphoid", signature = "LCK")
#hierachical.model <- edit_model(model = hierachical.model, name = "Myeloid", negative = T,  signature = "SPI1")

# Layer 2: retain NK cells
#hierachical.model <- edit_model(model = hierachical.model, level = 2, name = "XX", signature =  c(""))


#model visuzliation

#plot_tree(hierarchical.model)
```

Filtering
```{r, collapse=T}
#obj <- scGate(data = obj, model = hierarchical.model, assay = DefaultAssay(obj))
#DimPlot(obj, cols = c(list(Impure = "gray", Pure = "#00ae60")))

```

#####


```{r, eval=F}

my_scGate_model <- edit_model(model = my_scGate_model, name = "Tcell", signature = c("CD3D","CD3G"))
my_scGate_model <- edit_model(model = my_scGate_model, name = "platelet", signature = c("PPBP"), negative=T)
my_scGate_model <- edit_model(model = my_scGate_model, name = "CD8", signature = c("CD8A","CD8B1"), level=2)


my_scGate_model <- edit_model(model = my_scGate_model, name = "Tcell", signature = c("CD3D","CD3G"), level=1, positive=T)
my_scGate_model <- edit_model(model = my_scGate_model, name = "platelet", signature = c("PPBP"), level=1, positive=F)
my_scGate_model <- edit_model(model = my_scGate_model, name = "CD8", signature = c("CD8A","CD8B"), level=2, positive=T)



#my_scGate_model <- edit_model(model = my_scGate_model, level = 1, positive = F, name = "platelet", signature = c("PPBP"))

#my_scGate_model <- edit_model(model = my_scGate_model, level = 1, positive = T, name = "platelet", signature = c("PPBP"))

#my_scGate_model <- edit_model(model = my_scGate_model, level = 1, positive = T, name = "Bcell", signature = c("MS4A1"))
#my_scGate_model <- edit_model(model = my_scGate_model, level = 1, positive = F, name = "platelet", signature = c("PPBP"))

#my_scGate_model <- edit_model(model = my_scGate_model, level = 1, positive = T, name = "immune", signature = c("PTPRC"))
#my_scGate_model <- edit_model(model = my_scGate_model, level = 2, positive = T, name = "lymhpid", signature = c("LCK"))

#my_scGate_model <- edit_model(model = my_scGate_model, level = 1, positive = T, name = "immune", signature = c("PTPRC"))
#my_scGate_model <- edit_model(model = my_scGate_model, level = 1, positive = F, name = "platelet", signature = c("PPBP"))
#my_scGate_model <- edit_model(model = my_scGate_model, level = 1, positive = T, name = "Tcell", signature = c("CD3E","CD3D"))
#my_scGate_model <- edit_model(model = my_scGate_model, level = 1, positive = F, name = "myeloid", signature = c("SPI1"))

```


Load default models from DB
```{r,collapse=TRUE}
models.DB <- scGate::get_scGateDB()

names(models.DB$human$generic)

names(models.DB$mouse$generic)

```

or alternatively, you can load models from your local folder (you can manually edit the models in Excel)
```{r}
# models_path = '/home/user/custom_model'
# models <- scGate::load_scGate_model(models_path) 
```

### Have a look at some model (for B cells and plasma cells)

TODO: plot_tree only run for level > 1
```{r message=F,results=F}
my_scGate_model <- models.DB$human$generic$PanBcell
plt.tree <- scGate::plot_tree(my_scGate_model)
plt.tree
```



## Run an example
```{r, collapse=T}
# run scGate
obj <- scGate(obj, model = my_scGate_model)
DimPlot(obj, cols = c(list(Impure = "gray", Pure = "#00ae60")))
```

## Visualize filtering results by layer

```{r,fig.height=8,fig.width=10 }
plots <- scGate::plot_levels(obj)
plots[["annotation"]] <- DimPlot(obj, group.by = "cell_type",label = T, repel =T,label.size = 3) + ggtitle("Author's manual annot") + NoLegend() 
wrap_plots(plots, ncol = 2)
```

## Evaluate performance of filtering compared to original annotation
```{r,collapse=T}
perf.scGate = scGate::performance.metrics(actual = obj$PanBcell, pred = obj$is.pure== "Pure")
perf.scGate
```

## fast evaluation of model modifications
```{r,fig.width=16,fig.height=12,collapse = T, message = F}
# first, get model performance for a current model on available testing data
my_scGate_model <- models.DB$human$generic$PanBcell
panBcell.performance <- test_my_model(my_scGate_model, target = "PanBcell")
panBcell.performance$performance
```

Now, you can perform some model modifications
```{r,collapse=T, message =F}
# Some (absurd) model modification
my.custom.model <- my_scGate_model
my.custom.model%>%tail(3)
## REMOVE negative Tcell layer in last level (it make no sense, but we do it only for demonstrative purposes)
my.custom.model <- my.custom.model[-18,]   
my.custom.model%>%tail(3)
```

And evaluate this consecuences in a fast way.
```{r,fig.width=16,fig.height=12,collapse = T, message = F}
## Evaluate how the new model performs
new.model.performance <- test_my_model(my.custom.model, testing.version = 'hsa.latest',target = "PanBcell",PLOT = F)
new.model.performance$performance  

```
Notice: dropping a relevant negative signature in the last level of your model, do not affect model recall, but precision get worst in all the provided datasets.


## Model creation from scratch
```{r}
my_model <- edit_model()  # model initizlization
# add a first signature
my_model <- edit_model(model = my_model, 
                       level = 1, positive = T, name = "immune", signature = c("PTPRC"))

my_model <- edit_model(model = my_model, 
                       level = 1, positive = F, name = "Epithelial", signature = c("CDH1","FLT1") )



my_model

```


You can also use this function to remove some signature given its level and name (remove =T)
```{r}
dropped_model <- edit_model(model = my_model, remove =TRUE, level = 1, name = "Epithelial")
dropped_model
```


You can edit a given signature 
```{r}
model_imputed <- edit_signature(model = my_model, level = 1, name = "Epithelial", signature = c("CDH1","FLT1"),method = "replace" )
model_imputed
```




