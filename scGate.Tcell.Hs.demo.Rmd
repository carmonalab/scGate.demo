---
title: "Test basic functionalities of scGate on human data: Myeloid antigen presenting cells" 
author: "M. Andreatta, A. Berenstein and S. Carmona"
date: "19/08/2021"
output:
  rmdformats::readthedown:
    self-contained: true
    highlight: haddock
    thumbnails: false
    css: styles.css
knit: (function(input_file, encoding) {
  out_dir <- 'docs';
  rmarkdown::render(input_file, encoding=encoding,
  output_file=file.path(dirname(input_file), out_dir, 'scGate_MyeloidAPC_vignette.html'))})
---


```{r setup, echo=FALSE, message=F, warning=F, results=F}
install.packages("rmdformats")
install.packages("knitr")
install.packages("formatR")
#Template markdown setup
library(knitr)
library(rmdformats)
library(formatR)

#renv::restore()

## Global options
options(max.print="75")
opts_chunk$set(echo=TRUE,
	             cache=TRUE,
               cache.lazy=FALSE,
               prompt=FALSE,
               tidy=TRUE,
               comment=NA,
               message=FALSE,
               warning=FALSE,
               dev='png')
opts_knit$set(width=75)

```


 
## Background
**scGate** is an open source tool designed for gating specific and uncontaminated cell types in a scRNAseq experiment. We aim to gate cell subtypes at high precision/PPV (i.e achieving high cell type purity) and we donâ€™t care about some loss of true cells (i.e. sensitivity > 90% is ideal). We aim at a reliable tool to purify individual cell types from scRNA-seq data from complex samples (e.g. whole tissue, whole tumor) to enable i) downstream cell type-specific analysis (e.g. reference-atlas projection) and ii) cross-study comparisons/meta-analysis of cell types.


### Usage
The simplest usage mode allows users an automatic gating process of cell subsets based on pre-computed models that relies on specific cell signatures of interest.  The tool also allows an advanced mode in which users can create their own models based on personalized signatures,  as well as new training datasets. 

## This demo
Here, we are going to show the basic functionality of *scGate* package for filtering-out specific cell subsets in different scRNAseq datasets with pre-computed models. We will show how to extract **T cells** and also **TCD8 cells**  subsets  from two recent human single cell datasets: [Jerby-Arnon.2018](https://pubmed.ncbi.nlm.nih.gov/30388455/),  [Yost.2019](https://www.nature.com/articles/s41591-019-0522-3) 


## R Environment
```{bash}
#git clone https://github.com/carmonalab/scGate.demo
#cd scGate.demo
```

```{r}
if (!requireNamespace("renv")) install.packages("renv")
#renv::activate()
renv::restore()
library(dplyr)
library(ggplot2)
```


## Installation
```{r message=F, warning=F, results=F}
install.packages("remotes")
remotes::install_github("carmonalab/UCell")
remotes::install_github("carmonalab/scGate", ref="dev")

library(scGate)
seed <- 27182
```


# Get human datasets 
* For a detailed description of filtering and basic preprocessing of these datasets see the [Jerby_York_Li_preprocessing.html](url_path_to_notebook).
```{r}
do_download <- FALSE

ddir <- "input"
if (!file.exists(ddir)) {
    dir.create(ddir)
}

if (do_download) {
  #JerbyArnon - melanoma (GSE115978)
  dataUrl <- "https://drive.switch.ch/index.php/s/GOpKFDP1wtVR3x8/download"
  download.file(dataUrl, paste0(ddir, "/human_Mel_JerbyArnon.rds"))

  #Yost et al. - basal cell carcinoma (GSE123813)
  dataUrl <- "https://drive.switch.ch/index.php/s/dEfDpaWaFeyoAD3/download"
  download.file(dataUrl, paste0(ddir, "/Yost.pretreatment.all.rds"))
}
```

Load datasets and perform dimensionality reduction and unsupervised analysis
```{r}

# Load data into a list
# Unfiy author annotations in a new column "cell_type"
# Basic Preprocessing
if(!file.exists("input/human.sets.dimred.rds")){
  dataset.list <- list()
  
  a <- readRDS(paste0(ddir,"/human_Mel_JerbyArnon.rds"))
  a$Source <- "Jerby"
  a <- AddMetaData(a, a$cell.types, col.name = "cell_type")
  a <- a%>%subset(cell_type != "?") ## Fiter out 307 unannotated cells
  dataset.list[["Jerby"]] <- a


  a <- readRDS(paste0(ddir,"/Yost.pretreatment.all.rds"))
  a$Source <- "Yost"
  a <- AddMetaData(a, a$cluster, col.name = "cell_type")
  dataset.list[["Yost"]] <- a
  
  ## Preprocess 
  # Dimensionality reduction and unsup. analysis
  set.seed(seed)
  
  for (set in names(dataset.list)) {
    q <- dataset.list[[set]]
    
    q <- NormalizeData(q, verbose = FALSE)
    q <- FindVariableFeatures(q, selection.method = "vst", nfeatures = 1000, verbose = FALSE)
    
    q <- ScaleData(q)
    q <- RunPCA(q, features = q@assays$RNA@var.features, ndims.print = 1:5, nfeatures.print = 5, verbose = FALSE) 
    q <- RunUMAP(q, reduction = "pca", dims = 1:20, seed.use= seed, verbose = FALSE)
    
  
    dataset.list[[set]] <- q
  }
  
  saveRDS(dataset.list,"input/human.sets.dimred.rds")
}else{
  dataset.list <- readRDS("input/human.sets.dimred.rds")
}
```


Visualize the authors' annotations.
```{r,  message=F, fig.width= 11, fig.height=8}
dimplots <- list()
for(set in names(dataset.list)){
  dimplots[[set]] <- DimPlot(object = dataset.list[[set]], reduction = "umap", group.by = "cell_type", label = TRUE, label.size = 3, repel = TRUE) + ggtitle("") + labs(subtitle = "Cell Type") + theme(plot.subtitle = element_text(hjust = 0.5)) +theme(legend.position="bottom")
}

(dimplots$Jerby +ggtitle("Jerby et.al.")) + (dimplots$Yost + ggtitle("Yost et.al.")) 
```

Download scGate models from repo
```{r}
#Download the latest version
models <- scGate::get_scGateDB()

#Download a specific version
models.v02 <- scGate::get_scGateDB(version = "v0.2")
```

## Gating T cells

```{r, message=F}
gated <- list()
#Yost dataset
gated$Yost <- scGate(data = dataset.list$Yost, model = models$human$generic$Tcell.alphabeta, ncores=4)  
#Jerby-Arnon dataset
gated$Jerby <- scGate(data = dataset.list$Jerby, model = models$human$generic$Tcell.alphabeta, ncores=4)  
```

```{r,fig.width= 10, fig.height=10}

dimplots.tcell <- list() 

dimplots.tcell$Yost <- DimPlot(object = gated$Yost, reduction = "umap", group.by = "is.pure", 
                               label = TRUE, label.size = 3, repel = TRUE) + ggtitle("")  
dimplots.tcell$Jerby <- DimPlot(object = gated$Jerby, reduction = "umap", group.by = "is.pure", 
                                label = TRUE, label.size = 3, repel = TRUE) + ggtitle("")  


layout <- "
AB
CD"

patchwork::wrap_plots(A = dimplots$Jerby + ggtitle("Jerby et.al.") + theme(legend.text = element_text(size=7)) ,
                      B = dimplots$Yost + ggtitle("Yost et.al.") + theme(legend.text = element_text(size=7)),  
                      C = dimplots.tcell$Jerby ,
                      D= dimplots.tcell$Yost, design = layout)


```

* Notice that output object still contains all cells in the original query set. Nevertheless, it contains the main output inside the metadata object named as: **is.pure**. We can use this feature for visualizing  or isolation purposes 

We also quantify the amount of cells filtered in authors' subsets

```{r, results='asis'}
writeLines("td, th { padding : 6px } th { background-color : brown ; color : white; border : 1px solid white; } td { color : brown ; border : 1px solid brown }", con = "mystyle.css")

# Jerby
knitr::kable(table(gated$Jerby@meta.data[,c("cell_type","is.pure")]),format = "html")

# Yost
knitr::kable(table(gated$Yost@meta.data[,c("cell_type","is.pure")]), format = "html")
```


You can isolate gated cells for downstream analysis
```{r}
Jerby.tcells <- subset(gated$Jerby, subset = is.pure == "Pure")
Yost.tcells <- subset(gated$Yost, subset = is.pure == "Pure")
```


## Gating TCD8 cells

```{r, message=F}
gated.cd8 <- list()
#Yost dataset
gated.cd8$Yost <- scGate(data = dataset.list$Yost, model = models$human$generic$CD8T, ncores=4)  
#Jerby-Arnon dataset
gated.cd8$Jerby <- scGate(data = dataset.list$Jerby, model = models$human$generic$CD8T, ncores=4)  
```

```{r,fig.width=12,fig.height=6}
jerby.plot <- DimPlot(object = gated.cd8$Jerby, reduction = "umap", group.by = "is.pure", 
                      label = TRUE, label.size = 3, repel = TRUE) + ggtitle("Jerby et. al.") + 
  labs(subtitle = "TCD8") +  theme(plot.subtitle = element_text(hjust = 0.5)) 


yost.plot <- DimPlot(object = gated.cd8$Yost, reduction = "umap", group.by = "is.pure", 
                     label = TRUE, label.size = 3, repel = TRUE) + ggtitle("Yost et. al.") + 
  labs(subtitle = "TCD8") +  theme(plot.subtitle = element_text(hjust = 0.5))

jerby.plot + yost.plot
```

Comparing results among authors' defined cell types
```{r, results='asis'}
writeLines("td, th { padding : 6px } th { background-color : brown ; color : white; border : 1px solid white; } td { color : brown ; border : 1px solid brown }", con = "mystyle.css")

# Jerby
knitr::kable(table(gated.cd8$Jerby@meta.data[,c("cell_type","is.pure")]),format = "html")

# Yost
knitr::kable(table(gated.cd8$Yost@meta.data[,c("cell_type","is.pure")]),format = "html")

```


## Further reading
The code and the package are available at the *scGate* [GitHub repository](https://github.com/carmonalab/scGate)


```{r,results=F}
#renv::snapshot()
```








