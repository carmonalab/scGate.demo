---
title: "Test basic functionalities of scGate on human data: isolating T cells" 
author: "M. Andreatta, A. Berenstein and S. Carmona"
date: "19/08/2021"
output:
  rmdformats::readthedown:
    self-contained: true
    highlight: haddock
    thumbnails: false
    css: styles.css
knit: (function(input_file, encoding) {
  out_dir <- 'docs';
  rmarkdown::render(input_file, encoding=encoding,
  output_file=file.path(dirname(input_file), out_dir, 'TCell.vignette.html'))})
---



## Background
**scGate** is an open source tool designed for gating specific and uncontaminated cell types in a scRNAseq experiment. We aim to gate cell subtypes at high precision/PPV (i.e achieving high cell type purity) and we donâ€™t care about some loss of true cells (i.e. sensitivity > 90% is ideal). We aim at a reliable tool to purify individual cell types from scRNA-seq data from complex samples (e.g. whole tissue, whole tumor) to enable i) downstream cell type-specific analysis (e.g. reference-atlas projection) and ii) cross-study comparisons/meta-analysis of cell types.

### Usage
The simplest usage mode allows users an automatic gating process of cell subsets based on pre-computed models that relies on specific cell signatures of interest.  The tool also allows an advanced mode in which users can create their own models based on personalized signatures,  as well as new training datasets. 

## This demo
Here, we are going to show the basic functionality of *scGate* package for filtering-out specific cell subsets in different scRNAseq datasets with pre-computed models. We will show how to extract **T cells** and also **TCD8 cells**  subsets  from two recent human single cell datasets: [Jerby-Arnon.2018](https://pubmed.ncbi.nlm.nih.gov/30388455/),  [Yost.2019](https://www.nature.com/articles/s41591-019-0522-3) 


## R Environment

Using Renv
```{r, message=F, warning=F}
if (!requireNamespace("renv")) install.packages("renv")
renv::activate()
renv::restore()
library(dplyr)
library(ggplot2)
library(scGate)
library(patchwork)

```

Or alternatively, manually installing scGate from GitHub
```{r, eval=F, message=F, warning=F}
if (!requireNamespace("remotes")) install.packages("remotes")
remotes::install_github("carmonalab/UCell")
remotes::install_github("carmonalab/scGate")
library(scGate)
```


```{r setup, echo=FALSE, message=F, warning=F, results=F}
library(knitr)
library(rmdformats)
library(formatR)


## Global options
options(max.print="75")
opts_chunk$set(echo=TRUE,
	             cache=TRUE,
               cache.lazy=FALSE,
               prompt=FALSE,
               tidy=TRUE,
               comment=NA,
               message=FALSE,
               warning=FALSE,
               dev='png')
opts_knit$set(width=75)

## figure output path 
opath <- "~/Dropbox/CSI/PAPERS/scGate/Figures"
```
 


## Get human datasets 
* We are going to analyze two recent datasets, Brief description of datasets sources and processing. 

```{r}
do_download <- F

ddir <- "input"
if (!file.exists(ddir)) {
    dir.create(ddir)
}

if (do_download) {
  #JerbyArnon - melanoma (GSE115978)
  dataUrl <- "https://drive.switch.ch/index.php/s/GOpKFDP1wtVR3x8/download"
  download.file(dataUrl, paste0(ddir, "/human_Mel_JerbyArnon.rds"))

  #Yost et al. - basal cell carcinoma (GSE123813)
  dataUrl <- "https://drive.switch.ch/index.php/s/dEfDpaWaFeyoAD3/download"
  download.file(dataUrl, paste0(ddir, "/Yost.pretreatment.all.rds"))
}
```

## Basic Seurat unsupervised analysis 
Load datasets and permorm dimensionality reduction and unsupervised analysis.
```{r}
# In this chunck we will 
# a) Load data into a list
# b) Unfiy author annotations in a new column "cell_type"
# c) do some basic data preprocessing

seed <- 27182  #pseudo random seed to be used

if(!file.exists("input/human.sets.dimred.rds")){
  dataset.list <- list()
  
  a <- readRDS(paste0(ddir,"/human_Mel_JerbyArnon.rds"))
  a$Source <- "Jerby"
  a <- AddMetaData(a, a$cell.types, col.name = "cell_type")
  a <- a%>%subset(cell_type != "?") ## Fiter out 307 unannotated cells
  dataset.list[["Jerby"]] <- a


  a <- readRDS(paste0(ddir,"/Yost.pretreatment.all.rds"))
  a$Source <- "Yost"
  a <- AddMetaData(a, a$cluster, col.name = "cell_type")
  dataset.list[["Yost"]] <- a
  
  ## Preprocess 
  # Dimensionality reduction and unsup. analysis
  set.seed(seed)
  
  for (set in names(dataset.list)) {
    q <- dataset.list[[set]]
    
    q <- NormalizeData(q, verbose = FALSE)
    q <- FindVariableFeatures(q, selection.method = "vst", nfeatures = 1000, verbose = FALSE)
    
    q <- ScaleData(q)
    q <- RunPCA(q, features = q@assays$RNA@var.features, ndims.print = 1:5, nfeatures.print = 5, verbose = FALSE) 
    q <- RunUMAP(q, reduction = "pca", dims = 1:20, seed.use= seed, verbose = FALSE)
    
  
    dataset.list[[set]] <- q
  }
  
  saveRDS(dataset.list,"input/human.sets.dimred.rds")
}else{
  dataset.list <- readRDS("input/human.sets.dimred.rds")
}
```


Visualize the authors' annotations.
```{r,  message=F, fig.width= 12, fig.height=7}
dimplot.Jerby <- DimPlot(object = dataset.list$Jerby, reduction = "umap", group.by = "cell_type", label = TRUE, label.size = 3, repel = TRUE) + ggtitle("") + labs(subtitle = "Cell Type") + theme(plot.subtitle = element_text(hjust = 0.5)) +theme(legend.position="bottom") + theme(aspect.ratio = 1) +theme(legend.text = element_text(size=7))

dimplot.Yost <- DimPlot(object = dataset.list$Yost, reduction = "umap", group.by = "cell_type", label = TRUE, label.size = 3, repel = TRUE) + ggtitle("") + labs(subtitle = "Cell Type") + theme(plot.subtitle = element_text(hjust = 0.5)) +theme(legend.position="bottom") + theme(aspect.ratio = 1) + theme(legend.text = element_text(size=7))


(dimplot.Jerby + ggtitle("Jerby et.al.")) + (dimplot.Yost + ggtitle("Yost et.al."))
```

## Apply scGate to filter T cells. 
For each dataset we will apply a pre-trained model for filtering T cells. 

The required inputs for scGate are: 
1) the single cell dataset to filtered out in seurat format.
2) a scGate model trained to isolate an specific cell subset. 

scGate returns the same input Seurat object with an extra metadata feature named "is.pure" with two possible values: "Pure" or "Impure".

```{r, message=F,eval=T,results=F,echo =F}
if(!file.exists('./input/tcell.human.sets.rds')){                           ### ELIMINAR 
  gated.Tcell.Jerby <- scGate(data = dataset.list$Jerby, gating.model = scGate_DB$human$Tcell)  
  gated.Tcell.Yost <- scGate(data = dataset.list$Yost, gating.model = scGate_DB$human$Tcell)  
  tcell.gating <- list(Jerby = gated.Tcell.Jerby, Yost = gated.Tcell.Yost)  ### ELIMINAR
  saveRDS(tcell.gating,'./input/tcell.human.sets.rds')                       ### ELIMINAR
}else{                                                                      ### ELIMINAR
  tcell.gating <- readRDS('./input/tcell.human.sets.rds')                   ### ELIMINAR
  gated.Tcell.Jerby <- tcell.gating$Jerby                                   ### ELIMINAR
  gated.Tcell.Yost <- tcell.gating$Yost                                     ### ELIMINAR
}                                                                           ### ELIMINAR

```


```{r,message=F,eval=F}
gated.Tcell.Jerby <- scGate(data = dataset.list$Jerby, gating.model = scGate_DB$human$Tcell)  
gated.Tcell.Yost <- scGate(data = dataset.list$Yost, gating.model = scGate_DB$human$Tcell)  

```


How many T cells were fund?
```{r}
gated.Tcell.Jerby$is.pure %>% table()
gated.Tcell.Yost$is.pure %>% table()
```

We can use the **is.pure** feature for visualizing  or isolation purposes 

```{r,fig.width= 10, fig.height=10}
dimplot.tcell.Jerby <- DimPlot(object = gated.Tcell.Jerby, reduction = "umap", group.by = "is.pure", label = TRUE, label.size = 3, repel = TRUE) + ggtitle("")  + theme(aspect.ratio = 1)

dimplot.tcell.Yost <- DimPlot(object = gated.Tcell.Yost, reduction = "umap", group.by = "is.pure", label = TRUE, label.size = 3, repel = TRUE) + ggtitle("")  + theme(aspect.ratio = 1)

## prepare layout
layout <- "
AB
CD"

## show plots
plt <- patchwork::wrap_plots(A = dimplot.Jerby + ggtitle("Jerby et.al.") + theme(legend.text = element_text(size=7)) ,
                      B = dimplot.Yost + ggtitle("Yost et.al.") + theme(legend.text = element_text(size=7)),  
                      C = dimplot.tcell.Jerby ,
                      D= dimplot.tcell.Yost, design = layout) + plot_annotation(tag_levels = 'A')
plt
```


```{r,results=F,warning=F,echo = F,eval=F}
fname = file.path(opath,"dimplot_tcell_jerby_yost.pdf")
ggsave(filename = fname, plot = plt, width = 10, height = 10)

fname = file.path(opath,"dimplot_tcell_jerby_yost.png")
ggsave(filename = fname, plot = plt, width = 10, height = 10)
```



We also can quantify the amount of cells filtered in authors' subsets

```{r, fig.height= 5, fig.width=10}
# Jerby
df <- gated.Tcell.Jerby@meta.data
#reorder labes for visualization purposes. 
sorted.levels <- gated.Tcell.Jerby@meta.data%>%group_by(cell_type)%>%dplyr::summarise(Isolated = sum(is.pure =='Pure'))%>%arrange(desc(Isolated)) # extract order acording to Nro Pure detected cells
df$cell_type <- factor(df$cell_type, level = sorted.levels$cell_type)  

#create the barplot
jerby.bp <-ggplot(df, aes(x = cell_type,  fill = is.pure)) + geom_bar() + theme_bw() + theme(aspect.ratio = 1) + theme(axis.text.x = element_text(angle = 60, vjust = 0.5, hjust=0.5)) + ggtitle("Jerby et.al.") + xlab("author's criteria")

# Yost
df <- gated.Tcell.Yost@meta.data
#reorder labes for visualization purposes.
sorted.levels <- df%>%group_by(cell_type)%>%dplyr::summarise(Isolated = sum(is.pure =='Pure'))%>%arrange(desc(Isolated))  # extract order acording to Nro Pure detected cells
df$cell_type <- factor(df$cell_type, level = sorted.levels$cell_type) 

#create the barplot
yost.bp <- ggplot(df, aes(x = cell_type,  fill = is.pure)) + geom_bar() + theme_bw() + theme(aspect.ratio = 1) + theme(axis.text.x = element_text(angle = 60, vjust = 0.5, hjust=0.5)) + ggtitle("Yost et.al.") + xlab("author's criteria")

#show plots
jerby.bp + yost.bp
```

```{r,results=F,warning=F,echo = F,eval=F}
plt <- (jerby.bp + yost.bp)  + plot_annotation(tag_levels = 'A')
fname = file.path(opath,"barplot_Tcell_Jerby_Yost.pdf")
ggsave(filename = fname, plot = plt, width = 10, height = 5)

fname = file.path(opath,"barplot_Tcell_Jerby_Yost.png")
ggsave(filename = fname, plot = plt, width = 10, height = 5)
```


Finally, you can isolate gated cells for downstream analysis
```{r}
#Isolate Jerby T cells
Jerby.tcells <- tcell.gating$Jerby %>% subset(is.pure == "Pure")

#Isolate Yost T cells
Yost.tcells <- tcell.gating$Yost %>% subset(is.pure == "Pure")
```

And visualize those filtered datasets
```{r,fig.width= 10,fig.height=5}
# visualize Jerby T cells. 
jp <- DimPlot(Jerby.tcells, group.by = "cell_type",label = TRUE, label.size = 3, repel = TRUE) + ggtitle("Jerby et.al.") + theme(aspect.ratio = 1) +theme(legend.position="bottom") + theme(legend.text = element_text(size=7)) 

# visualize Yost T cells
yp <- DimPlot(Yost.tcells, group.by = "cell_type",label = TRUE, label.size = 3, repel = TRUE) + ggtitle("Yost et.al.")  + theme(aspect.ratio = 1) +theme(legend.position="bottom") + theme(legend.text = element_text(size=7)) 

# Show plots
jp + yp
```

```{r,results=F,warning=F,echo = F,eval=F}
plt <- (jp + yp) + plot_annotation(tag_levels = 'A')
fname = file.path(opath,"isolated_dimplot_Tcell_Jerby_Yost.pdf")
ggsave(filename = fname, plot = plt, width = 10, height = 5)

fname = file.path(opath,"isolated_dimplot_Tcell_Jerby_Yost.png")
ggsave(filename = fname, plot = plt, width = 10, height = 5)
```


# Advanced features
In addition to the main **is.pure** feature, scGate offers two additional outputs for downstream analysis and exploration: **sc.Gate.annotation** field and **zscore signatures**. 

## sc.Gate.annotation field
First, scGate allows to display the most probable class of the **impure** cells. This can easily visualized by using **sc.Gate.annotation** field, also available into the meta.data of the output. 

Please, notice that this **IS NOT** the main output of scGate tool and that *this annotation is not error free*. This must be used only as a *complementary analysis tool* and *never for isolation/filtering purposes*. 

You can found it easily:
```{r, fig.width= 10, fig.height= 5}
# visualize scGate annotations in Jerby dataset 
p1 <- DimPlot(gated.Tcell.Jerby,group.by = "scGate.annotation",label = TRUE, label.size = 3, repel = TRUE ) + NoLegend() + ggtitle("")  + labs(subtitle = "Jerby et.al.") +theme(aspect.ratio = 1) +  theme(legend.text = element_text(size=7)) 

# visualize scGte annotations in Yost dataset
p2 <- DimPlot(gated.Tcell.Yost,group.by = "scGate.annotation",label = TRUE, label.size = 3, repel = TRUE) + NoLegend() + ggtitle("") + labs(subtitle =  "Yost et.al.") + theme(aspect.ratio = 1) +  theme(legend.text = element_text(size=7)) 

# Show plots
p1 + p2
```

```{r,results=F,warning=F,echo = F,eval=F}
plt <- (p1 + p2) + plot_annotation(tag_levels = 'A')
fname = file.path(opath,"scGate.annotation_Tcell_Jerby_Yost.pdf")
ggsave(filename = fname, plot = plt, width = 10, height = 5)

fname = file.path(opath,"scGate.annotation_Tcell_Jerby_Yost.png")
ggsave(filename = fname, plot = plt, width = 10, height = 5)
```


## z-score signatures
Another useful feature of scGate is that it reserves the considered z-scores that have been used for filtering purposes. By default scGate uses [Ucell](https://github.com/carmonalab/UCell) z-scores and reserve them in meta.data object.  
These z-scores can be easily located and visualized:
```{r}
mtd <- gated.Tcell.Yost@meta.data
zscore_cols <-  colnames(mtd)%>%grep('_Zscore',.,value=T) 
zscore_signatures <-  mtd[,zscore_cols] # get all zscore signatures
#zscore_signatures %>% head()

zscore_cols %>% tail() ## display some signature names
```

And you can visualize it by taking adavantage of FeaturePlot Seurat function:
```{r,fig.width=10,fig.height=9}
plot.signatures <- FeaturePlot(gated.Tcell.Yost, features = c("Plasma.cells_Zscore","pDC_Zscore","NK_Zscore","B.cell_Zscore"))
plot.signatures
```

```{r,results=F,warning=F,echo = F,eval=F}
plt <- plot.signatures + plot_annotation(tag_levels = 'A')
fname = file.path(opath,"signatures_Tcell_Jerby_Yost.pdf")
ggsave(filename = fname, plot = plt, width = 10, height = 10)

fname = file.path(opath,"signatures_Tcell_Jerby_Yost.png")
ggsave(filename = fname, plot = plt, width = 10, height = 10)
```


# Further reading
The code and the package are available at the *scGate* [GitHub repository](https://github.com/carmonalab/scGate)



